
# API {#API}
<details class='jldocstring custom-block' open>
<summary><a id='Microclimate.McCulloughPorterSolarGeometry' href='#Microclimate.McCulloughPorterSolarGeometry'><span class="jlbinding">Microclimate.McCulloughPorterSolarGeometry</span></a> <Badge type="info" class="jlObjectType jlType" text="Type" /></summary>



```julia
solar_geometry(d::Real, latitude::Quantity, h::Quantity; d0::Real = 80, ω::Real = 2π/365, ϵ::Real = 0.0167, se::Real = 0.39779)
```


Computes key solar geometry parameters based on McCullough &amp; Porter (1971):
- `ζ`: Auxiliary solar longitude (radians)
  
- `δ`: Solar declination (radians)
  
- `z`: Solar zenith angle (radians)
  
- `AR2`: Square of Earth-to-Sun radius factor (unitless)
  

**Arguments**
- `d`: Day of year (1–365)
  
- `latitude`: Latitude (with angle units, e.g. `u"°"` or `u"rad"`)
  
- `h`: Hour angle (radians)
  
- `d0`: Reference day (default: 80)
  
- `ω`: Angular frequency of Earth’s orbit (default: `2π/365`)
  
- `ϵ`: Orbital eccentricity (default: `0.0167`)
  
- `se`: Constant for solar declination amplitude (default: `0.39779`)
  

**Returns**

Tuple: `(ζ, δ, z, AR2)` with angle quantities in radians and AR2 unitless.

**Reference**

McCullough &amp; Porter (1971)


<Badge type="info" class="source-link" text="source"><a href="https://github.com/BiophysicalEcology/Microclimate.jl/blob/249615d416695025a74967af1bdbeecbc4c201a6/src/radiation.jl#L47-L72" target="_blank" rel="noreferrer">source</a></Badge>

</details>

<details class='jldocstring custom-block' open>
<summary><a id='Microclimate.MicroProblem' href='#Microclimate.MicroProblem'><span class="jlbinding">Microclimate.MicroProblem</span></a> <Badge type="info" class="jlObjectType jlType" text="Type" /></summary>



```julia
MicroProblem(...)
```


Simulates soil and microclimate dynamics over multiple days.

**Overview generated by ChatGPT**
- Interpolates daily min/max weather (temperature, wind, humidity, cloud) to hourly steps.
  
- Solves the soil energy balance using an ODE each hour.
  
- Optionally simulates soil moisture (`runmoist=true`).
  
- Returns detailed outputs for soil, air, radiation, and water balance.
  

**Hourly Weather Interpolation**
- Daily min/max values are interpolated to 24-hour vectors  (e.g. `TAIRs`).
  
- Matches the Fortran/R approach where an extra hour smooths  interpolation.
  

**Soil Layer Setup**
- `numnodes_a`: number of nodes for temperature output.
  
- `numnodes_b`: expanded nodes for moisture (`numnodes_a * 2 - 2`).
  
- Initializes temperature (`θ_soil0_a`) and moisture (`θ_soil0_b`).
  
- Tracks water phase transitions in `Σphase`.
  

**Solar Radiation**
- `solrad` computes clear-sky radiation.
  
- Zenith angles capped at 90°.
  
- Clouds adjust radiation with `cloud_adjust_radiation`.
  

**Time Loop**
- Outer loop: days.
  
- Inner loop: hours.
  
- Supports spin-up or multi-iteration (`iterate_day`).
  
- Each hour:
  - `soil_energy_balance!` updates temperature.
    
  - `get_soil_water_balance` updates moisture (optional).
    
  - Soil properties (`λ_bulk`, `c_p_bulk`, `ρ_bulk`) updated.
    
  - Sky temperature computed with `longwave_radiation`.
    
  

**Profiles**
- After all days, computes air, wind, humidity profiles via `atmospheric_surface_profile`.
  
- Results are &quot;flipped&quot; into vectors with `flip2vectors`.
  

**Return Values**

Returns a named tuple containing:
- Air/wind/RH profiles
  
- Cloud cover and solar radiation
  
- Soil temperature, moisture, water potential, RH
  
- Soil thermal properties and bulk density
  
- Surface water pools
  
- `solrad_out` and `profile_out` for detailed internals
  

**Notes**
- **Units**: Uses `Unitful.jl`. Ensure all functions preserve units.
  
- **Memory**: Large arrays (`T_soils`, `θ_soils`):verbose set showmode? may be heavy for long runs.
  
- **Interpolation**: Extra 25th hour is correct but needs careful indexing.
  
- **Phase tranitions**: Applied hourly; check `Σphase` across multi-day runs.
  
- **Moisture logic**: Updates depend on `i == 1` or `i < length(hours)`; confirm matches Fortran/R logic.
  


<Badge type="info" class="source-link" text="source"><a href="https://github.com/BiophysicalEcology/Microclimate.jl/blob/249615d416695025a74967af1bdbeecbc4c201a6/src/simulation.jl#L1-L66" target="_blank" rel="noreferrer">source</a></Badge>

</details>

<details class='jldocstring custom-block' open>
<summary><a id='Microclimate.SolarRadiation' href='#Microclimate.SolarRadiation'><span class="jlbinding">Microclimate.SolarRadiation</span></a> <Badge type="info" class="jlObjectType jlType" text="Type" /></summary>



```julia
SolarRadiation
```


**TODO who wrote this model what is it called**

**Keyword Arguments**
- `cmH2O::Real=1`: Precipitable water in cm for atmospheric column (e.g. 0.1: dry, 1.0: moist, 2.0: humid).
  
- `ϵ::Real=0.0167238`: Orbital eccentricity of Earth.
  
- `ω::Real=2π/365`: Mean angular orbital velocity of Earth (radians/day).
  
- `se::Real=0.39779`: Precomputed solar elevation constant.
  
- `d0::Real=80`: Reference day for declination calculations.
  
- `iuv::Bool=false`: If `true`, uses the full gamma-function model for diffuse radiation (expensive).
  
- `scattered::Bool=true`: If `true`, disables scattered light computations (faster).
  
- `amr::Quantity=25.0u"km"`: Mixing ratio height of the atmosphere.
  
- `nmax::Integer=111`: Maximum number of wavelength intervals.
  
- `Iλ::Vector{Quantity}`: Vector of wavelength bins (e.g. in `nm`).
  
- `OZ::Matrix{Float64}`: Ozone column depth table indexed by latitude band and month (size 19×12).
  
- `τR`, `τO`, `τA`, `τW`: Vectors of optical depths per wavelength for Rayleigh scattering, ozone, aerosols, and water vapor.
  
- `Sλ::Vector{Quantity}`: Solar spectral irradiance per wavelength bin (e.g. in `mW * cm^-2 * nm^-1`).
  
- `FD`, `FDQ`: Radiation scattered from the direct solar beam and reflected radiation   rescattered downward as a function of wavelength, from tables in Dave &amp; Furukawa (1966).
  
- `s̄`: a function of τR linked to molecular scattering in the UV range (&lt; 360 nm)
  


<Badge type="info" class="source-link" text="source"><a href="https://github.com/BiophysicalEcology/Microclimate.jl/blob/249615d416695025a74967af1bdbeecbc4c201a6/src/landscape.jl#L168-L191" target="_blank" rel="noreferrer">source</a></Badge>

</details>

<details class='jldocstring custom-block' open>
<summary><a id='Microclimate.atmospheric_surface_profile-Tuple{}' href='#Microclimate.atmospheric_surface_profile-Tuple{}'><span class="jlbinding">Microclimate.atmospheric_surface_profile</span></a> <Badge type="info" class="jlObjectType jlMethod" text="Method" /></summary>



```julia
atmospheric_surface_profile(; kwargs...)
```


Compute vertical profiles of wind speed, air temperature, and relative humidity  in the atmospheric surface layer, using Monin–Obukhov similarity theory (MOST).

This function reproduces the subroutine in `MICRO.f/get_profile.R` from **NicheMapR**, ported to Julia.   It calculates the microclimate profiles above the ground (or canopy) at specified heights, based on measured values at a reference height and computed or measured soil surface temperature, together with surface roughness parameters. Zenith angle and a maximum allowed surface temperature are used to assess whether conditions are stable or unstable.

**Keyword Arguments**
- `z0::Quantity=0.004u"m"`: roughness length (surface aerodynamic roughness).
  
- `zh::Quantity=0.0u"m"`: heat transfer roughness height
  
- `d0::Quantity=0.0u"m"`: zero plane displacement correction factor.
  
- `κ::Float64=0.4`: von Kármán constant.
  
- `heights::Vector{Quantity}`: Requested heights above the surface, the last being the reference height.
  
- `reference_temperature::Quantity=27.78u"°C"`: Air temperature at the reference height.
  
- `reference_wind_speed::Quantity=2.75u"m/s"`: Wind speed at the reference height.
  
- `relative_humidity::Float64=49.0`: Relative humidity at the reference height (%).
  
- `surface_temperature::Quantity=48.59u"°C"`: Soil or surface temperature.
  
- `zenith_angle::Quantity=21.5u"°"`: Solar zenith angle.
  
- `elevation::Quantity=0.0u"m"`: Elevation above sea level.
  

**Returns**

Named tuple with fields:
- `wind_speeds`: Wind speed profile at each height (`cm/min` internally, returned in SI units).
  
- `air_temperatures`: Air temperature profile at each height (`K`).
  
- `humidities`: Relative humidity (%) at each height.
  
- `Q_convection`: Convective heat flux (`W/m²`).
  
- `ustar`: Friction velocity (`m/s`).
  

**Notes**
- Stability corrections use the **Businger–Dyer** formulations for unstable conditions.
  
- The Monin–Obukhov length is estimated iteratively through `calc_Obukhov_length`.
  
- Two broad options for aerodynamic roughness calculations are available: Campbell &amp; Norman&#39;s (1998) approach
  

that handles canopy displacement, invoked if `zh > 0` and otherwise  
- When `zh > 0`, canopy displacement is considered in the profile calculation.
  
- zh and d0 for Campbell and Norman air temperature/wind speed profile (0.6 * canopy height in m if unknown
  

|                   Condition |                       Wind profile |                                  Temperature profile |
| ---------------------------:| ----------------------------------:| ----------------------------------------------------:|
|      `zh > 0` + neutral/hot |                            log-law |                             log between `z` and `zh` |
|  `zh > 0` + unstable/stable | log-law with `calc_ψ_m` correction |                           log with displacement/`zh` |
|     `zh == 0` + neutral/hot |                            log-law |            weighted by bulk/sublayer Stanton numbers |
| `zh == 0` + unstable/stable | log-law with `calc_ψ_m` correction | full Monin–Obukhov profile via `calc_Obukhov_length` |

- Relative humidity profiles are estimated from vapor pressure at each height.
  

**References**
- Businger, J. A., Wyngaard, J. C., Izumi, Y., &amp; Bradley, E. F. (1971). Flux–profile relationships in the atmospheric surface layer. _Journal of the Atmospheric Sciences_, 28(2), 181–189.
  
- Dyer, A. J. (1974). A review of flux–profile relationships. _Boundary-Layer Meteorology_, 7(3), 363–372.
  
- Kearney, M. R., et al. (2020). NicheMapR: an R package for microclimate and  biophysical modeling. _Ecography_, 43, 1–14.
  

**Example**

```julia
profile = atmospheric_surface_profile(
    reference_temperature = 25u"°C",
    reference_wind_speed = 2.0u"m/s",
    relative_humidity = 60.0,
    surface_temperature = 35u"°C",
    zenith_angle = 45u"°"
)

profile.air_temperatures  # vertical profile of air temperatures
profile.wind_speeds       # vertical profile of wind speeds
```



<Badge type="info" class="source-link" text="source"><a href="https://github.com/BiophysicalEcology/Microclimate.jl/blob/249615d416695025a74967af1bdbeecbc4c201a6/src/boundary_layer.jl#L11-L84" target="_blank" rel="noreferrer">source</a></Badge>

</details>

<details class='jldocstring custom-block' open>
<summary><a id='Microclimate.bulk_stanton-Tuple{Any, Any, Any}' href='#Microclimate.bulk_stanton-Tuple{Any, Any, Any}'><span class="jlbinding">Microclimate.bulk_stanton</span></a> <Badge type="info" class="jlObjectType jlMethod" text="Method" /></summary>



```julia
bulk_stanton(log_z_ratio, z, L_Obukhov)
```


Compute the bulk Stanton number for unstable conditions.


<Badge type="info" class="source-link" text="source"><a href="https://github.com/BiophysicalEcology/Microclimate.jl/blob/249615d416695025a74967af1bdbeecbc4c201a6/src/boundary_layer.jl#L332-L336" target="_blank" rel="noreferrer">source</a></Badge>

</details>

<details class='jldocstring custom-block' open>
<summary><a id='Microclimate.bulk_stanton-Tuple{Any}' href='#Microclimate.bulk_stanton-Tuple{Any}'><span class="jlbinding">Microclimate.bulk_stanton</span></a> <Badge type="info" class="jlObjectType jlMethod" text="Method" /></summary>



```julia
bulk_stanton(log_z_ratio)
```


Compute the bulk Stanton number for stable conditions.


<Badge type="info" class="source-link" text="source"><a href="https://github.com/BiophysicalEcology/Microclimate.jl/blob/249615d416695025a74967af1bdbeecbc4c201a6/src/boundary_layer.jl#L323-L327" target="_blank" rel="noreferrer">source</a></Badge>

</details>

<details class='jldocstring custom-block' open>
<summary><a id='Microclimate.calc_Obukhov_length-NTuple{10, Any}' href='#Microclimate.calc_Obukhov_length-NTuple{10, Any}'><span class="jlbinding">Microclimate.calc_Obukhov_length</span></a> <Badge type="info" class="jlObjectType jlMethod" text="Method" /></summary>



```julia
calc_Obukhov_length(T_ref_height, T_surface, v_ref_height, z, z0, ρcpTκg, κ, log_z_ratio, ΔT, ρ_cp, 
                     γ=16.0, max_iter=500, tol=1e-2)
```


Iteratively solve for Monin-Obukhov length and convective heat flux.


<Badge type="info" class="source-link" text="source"><a href="https://github.com/BiophysicalEcology/Microclimate.jl/blob/249615d416695025a74967af1bdbeecbc4c201a6/src/boundary_layer.jl#L422-L427" target="_blank" rel="noreferrer">source</a></Badge>

</details>

<details class='jldocstring custom-block' open>
<summary><a id='Microclimate.calc_convection-Tuple{}' href='#Microclimate.calc_convection-Tuple{}'><span class="jlbinding">Microclimate.calc_convection</span></a> <Badge type="info" class="jlObjectType jlMethod" text="Method" /></summary>



```julia
calc_convection(; u_star, log_z_ratio, ΔT, ρ_cp, z0)
```


Calculate the convective heat flux (sensible heat exchange between surface and air).

**Arguments**
- `u_star::Quantity{<:Real,𝐋/𝐓}`: Friction velocity (e.g. `m/s`, `cm/min`).
  
- `log_z_ratio::Real`: Precomputed logarithmic height ratio, typically `log(z/z0 + 1.0)`.
  
- `ΔT::Quantity{<:Real,Θ}`: Temperature difference between reference air and surface (Kelvin).
  
- `ρ_cp::Quantity{<:Real,(𝐌*𝐋^-1*𝐓^-2)}`: Volumetric heat capacity of air (e.g. `J/m³/K`, `cal/cm³/K`).
  
- `z0::Quantity{<:Real,𝐋}`: Surface roughness length (length).
  

**Returns**
- Convective heat flux as `Quantity{<:Real,(𝐌*𝐓^-3)}` (e.g. `W/m²`, `cal/min/cm²`).
  

Uses bulk and sublayer Stanton numbers to account for turbulence near the surface.

**See also**

[`calc_u_star`](/api#Microclimate.calc_u_star-Tuple{}), [`calc_wind`](/api#Microclimate.calc_wind-NTuple{5,%20Any}), [`sublayer_stanton`](/api#Microclimate.sublayer_stanton-Tuple{Any,%20Any}), [`bulk_stanton`](/api#Microclimate.bulk_stanton-Tuple{Any,%20Any,%20Any}), [`convective_flux`](/api#Microclimate.convective_flux-NTuple{5,%20Any})


<Badge type="info" class="source-link" text="source"><a href="https://github.com/BiophysicalEcology/Microclimate.jl/blob/249615d416695025a74967af1bdbeecbc4c201a6/src/boundary_layer.jl#L278-L297" target="_blank" rel="noreferrer">source</a></Badge>

</details>

<details class='jldocstring custom-block' open>
<summary><a id='Microclimate.calc_u_star-Tuple{}' href='#Microclimate.calc_u_star-Tuple{}'><span class="jlbinding">Microclimate.calc_u_star</span></a> <Badge type="info" class="jlObjectType jlMethod" text="Method" /></summary>



```julia
calc_u_star(; reference_wind_speed, log_z_ratio, κ=0.4)
```


Compute the friction velocity (u*) from a reference wind speed using the logarithmic wind profile.

**Arguments**
- `reference_wind_speed::Quantity{<:Real,𝐋/𝐓}`: Wind speed at the reference height (e.g. `m/s`, `cm/min`).
  
- `log_z_ratio::Real`: Precomputed log height ratio, typically `log(z/z0 + 1.0)`.
  
- `κ::Real`: von Kármán constant (default = 0.4).
  

**Returns**
- Friction velocity `u_star::Quantity{<:Real,𝐋/𝐓}`.
  

**See also**

[`calc_convection`](/api#Microclimate.calc_convection-Tuple{}), [`calc_wind`](/api#Microclimate.calc_wind-NTuple{5,%20Any})


<Badge type="info" class="source-link" text="source"><a href="https://github.com/BiophysicalEcology/Microclimate.jl/blob/249615d416695025a74967af1bdbeecbc4c201a6/src/boundary_layer.jl#L233-L249" target="_blank" rel="noreferrer">source</a></Badge>

</details>

<details class='jldocstring custom-block' open>
<summary><a id='Microclimate.calc_wind-NTuple{5, Any}' href='#Microclimate.calc_wind-NTuple{5, Any}'><span class="jlbinding">Microclimate.calc_wind</span></a> <Badge type="info" class="jlObjectType jlMethod" text="Method" /></summary>



```julia
calc_wind(z, z0, κ, u_star, b)
```


Calculate wind speed at height `z` using the logarithmic wind profile.

**Arguments**
- `z::Quantity{<:Real,𝐋}`: Height above the surface (e.g. `m`, `cm`).
  
- `z0::Quantity{<:Real,𝐋}`: Roughness length (e.g. `m`, `cm`).
  
- `κ::Real`: von Kármán constant.
  
- `u_star::Quantity{<:Real,𝐋/𝐓}`: Friction velocity.
  
- `b::Real`: Offset term (e.g. `1.0` for neutral stability, or stability correction).
  

**Returns**
- Wind speed at height `z::Quantity{<:Real,𝐋/𝐓}`.
  

**See also**

[`calc_u_star`](/api#Microclimate.calc_u_star-Tuple{}), [`calc_convection`](/api#Microclimate.calc_convection-Tuple{})


<Badge type="info" class="source-link" text="source"><a href="https://github.com/BiophysicalEcology/Microclimate.jl/blob/249615d416695025a74967af1bdbeecbc4c201a6/src/boundary_layer.jl#L255-L272" target="_blank" rel="noreferrer">source</a></Badge>

</details>

<details class='jldocstring custom-block' open>
<summary><a id='Microclimate.calc_ρ_cp-NTuple{4, Any}' href='#Microclimate.calc_ρ_cp-NTuple{4, Any}'><span class="jlbinding">Microclimate.calc_ρ_cp</span></a> <Badge type="info" class="jlObjectType jlMethod" text="Method" /></summary>



```julia
calc_ρ_cp(T_mean, elevation, relative_humidity)
```


Compute the volumetric heat capacity of moist air (ρ·cₚ) given temperature, elevation, and relative humidity.

**Arguments**
- `T_mean`: Mean air temperature (`Unitful.Temperature`), in Kelvin.
  
- `elevation`: Elevation above sea level (with units of length).
  
- `relative_humidity`: Relative humidity (fraction between 0 and 1).
  

**Returns**
- Volumetric heat capacity (`cal / (cm³·K)`).
  

Uses `dry_air_properties` to compute air density (ρ) and  `wet_air_properties` to compute specific heat capacity (cₚ).


<Badge type="info" class="source-link" text="source"><a href="https://github.com/BiophysicalEcology/Microclimate.jl/blob/249615d416695025a74967af1bdbeecbc4c201a6/src/boundary_layer.jl#L208-L224" target="_blank" rel="noreferrer">source</a></Badge>

</details>

<details class='jldocstring custom-block' open>
<summary><a id='Microclimate.calc_ρ_cp-Tuple{Any}' href='#Microclimate.calc_ρ_cp-Tuple{Any}'><span class="jlbinding">Microclimate.calc_ρ_cp</span></a> <Badge type="info" class="jlObjectType jlMethod" text="Method" /></summary>



```julia
calc_ρ_cp(T_mean)
```


Compute the volumetric heat capacity of air (ρ·cₚ) as a function of mean temperature.

**Arguments**
- `T_mean`: Mean air temperature (`Unitful.Temperature`), in Kelvin.
  

**Returns**
- Volumetric heat capacity (`cal / (cm³·K)`).
  

This is a simplified empirical regression based only on temperature, without accounting for moisture or elevation effects.


<Badge type="info" class="source-link" text="source"><a href="https://github.com/BiophysicalEcology/Microclimate.jl/blob/249615d416695025a74967af1bdbeecbc4c201a6/src/boundary_layer.jl#L190-L203" target="_blank" rel="noreferrer">source</a></Badge>

</details>

<details class='jldocstring custom-block' open>
<summary><a id='Microclimate.calc_φ_m-Tuple{Any, Any, Any}' href='#Microclimate.calc_φ_m-Tuple{Any, Any, Any}'><span class="jlbinding">Microclimate.calc_φ_m</span></a> <Badge type="info" class="jlObjectType jlMethod" text="Method" /></summary>



```julia
calc_φ_m(z, γ, L_Obukhov)
```


Stability correction function φ for momentum in Monin–Obukhov similarity theory (MOST).

**Arguments**
- `z`: Height above surface (with units of length).
  
- `γ`: Empirical constant (dimensionless, often ≈16).
  
- `L_Obukhov`: Monin–Obukhov length (with units of length).
  

**Returns**
- Dimensionless stability correction factor φ.
  

This corresponds to the Businger–Dyer formulation for unstable stratification:

φₘ = (1 - γ z / L)^(1/4)

**References**
- Businger, J. A., Wyngaard, J. C., Izumi, Y., &amp; Bradley, E. F. (1971). Flux–profile relationships in the atmospheric surface layer. _Journal of the Atmospheric Sciences_, 28(2), 181–189.
  
- Dyer, A. J. (1974). A review of flux–profile relationships. _Boundary-Layer Meteorology_, 7(3), 363–372.
  


<Badge type="info" class="source-link" text="source"><a href="https://github.com/BiophysicalEcology/Microclimate.jl/blob/249615d416695025a74967af1bdbeecbc4c201a6/src/boundary_layer.jl#L342-L365" target="_blank" rel="noreferrer">source</a></Badge>

</details>

<details class='jldocstring custom-block' open>
<summary><a id='Microclimate.calc_ψ_h-Tuple{Any}' href='#Microclimate.calc_ψ_h-Tuple{Any}'><span class="jlbinding">Microclimate.calc_ψ_h</span></a> <Badge type="info" class="jlObjectType jlMethod" text="Method" /></summary>



```julia
calc_ψ_h(x)
```


Stability correction function ψ_h for heat and moisture under unstable conditions, used in Monin–Obukhov similarity theory.

**Arguments**
- `x`: Dimensionless argument, typically `(1 - γ z / L)^(1/4)`.
  

**Returns**
- Correction factor ψ_h (dimensionless).
  

This is the Businger–Dyer form for scalars:

ψ_h(x) = 2 ln((1 + x²) / 2)

**References**
- Businger et al. (1971).
  
- Dyer (1974).
  


<Badge type="info" class="source-link" text="source"><a href="https://github.com/BiophysicalEcology/Microclimate.jl/blob/249615d416695025a74967af1bdbeecbc4c201a6/src/boundary_layer.jl#L397-L416" target="_blank" rel="noreferrer">source</a></Badge>

</details>

<details class='jldocstring custom-block' open>
<summary><a id='Microclimate.calc_ψ_m-Tuple{Any}' href='#Microclimate.calc_ψ_m-Tuple{Any}'><span class="jlbinding">Microclimate.calc_ψ_m</span></a> <Badge type="info" class="jlObjectType jlMethod" text="Method" /></summary>



```julia
calc_ψ_m(x)
```


Stability correction function ψₘ for momentum under unstable atmospheric stratification, used in Monin–Obukhov similarity theory.

**Arguments**
- `x`: Dimensionless argument, typically `(1 - γ z / L)^(1/4)`.
  

**Returns**
- Correction factor ψₘ (dimensionless).
  

This is the Businger–Dyer form for momentum:

ψₘ(x) = 2 ln((1 + x) / 2) + ln((1 + x²) / 2) - 2 atan(x) + π/2

**References**
- Businger et al. (1971).
  
- Dyer (1974).
  


<Badge type="info" class="source-link" text="source"><a href="https://github.com/BiophysicalEcology/Microclimate.jl/blob/249615d416695025a74967af1bdbeecbc4c201a6/src/boundary_layer.jl#L372-L391" target="_blank" rel="noreferrer">source</a></Badge>

</details>

<details class='jldocstring custom-block' open>
<summary><a id='Microclimate.cloud_adjust_radiation!-Tuple{Any, AbstractArray, Any, Any, AbstractArray, Any}' href='#Microclimate.cloud_adjust_radiation!-Tuple{Any, AbstractArray, Any, Any, AbstractArray, Any}'><span class="jlbinding">Microclimate.cloud_adjust_radiation!</span></a> <Badge type="info" class="jlObjectType jlMethod" text="Method" /></summary>



```julia
cloud_adjust_radiation(cloud, D_cs, B_cs, zenith, doy; a=0.25, b=0.5, gamma=1.0)
```


Compute global (G), diffuse (D), and direct-beam (B) solar on a horizontal surface given cloud cover fraction `cloud` (0–1), clear-sky diffuse `D_cs` and direct `B_cs`, solar zenith angle `zenith` (radians), and day-of-year `doy`.
- Ångström scaling: G = (a + b*S) * (D_cs + B_cs), with S ≈ (1 - cloud)^gamma
  
- Diffuse fraction via Erbs (uses extraterrestrial horizontal irradiance) via   a clearness index (Maxwwell 1987) which is the ratio of global to extraterrestrial   irradiance on a horizontal plane
  

Returns `(G, D, B)`; works with arrays but needs to not use &#39;similar&#39; if to work with     scalars.

Reference Maxwell, E. L., &quot;A Quasi-Physical Model for Converting Hourly            Global Horizontal to Direct Normal Insolation&quot;, Technical            Report No. SERI/TR-215-3087, Golden, CO: Solar Energy Research            Institute, 1987.


<Badge type="info" class="source-link" text="source"><a href="https://github.com/BiophysicalEcology/Microclimate.jl/blob/249615d416695025a74967af1bdbeecbc4c201a6/src/radiation.jl#L1621-L1641" target="_blank" rel="noreferrer">source</a></Badge>

</details>

<details class='jldocstring custom-block' open>
<summary><a id='Microclimate.convective_flux-NTuple{5, Any}' href='#Microclimate.convective_flux-NTuple{5, Any}'><span class="jlbinding">Microclimate.convective_flux</span></a> <Badge type="info" class="jlObjectType jlMethod" text="Method" /></summary>



```julia
convective_flux(ρ_cp, ΔT, u_star, St_bulk, St_sublayer)
```


Compute convective heat flux given bulk and sublayer Stanton numbers.


<Badge type="info" class="source-link" text="source"><a href="https://github.com/BiophysicalEcology/Microclimate.jl/blob/249615d416695025a74967af1bdbeecbc4c201a6/src/boundary_layer.jl#L304-L308" target="_blank" rel="noreferrer">source</a></Badge>

</details>

<details class='jldocstring custom-block' open>
<summary><a id='Microclimate.dchxy-Tuple{Float64, Vector{Float64}, Int64}' href='#Microclimate.dchxy-Tuple{Float64, Vector{Float64}, Int64}'><span class="jlbinding">Microclimate.dchxy</span></a> <Badge type="info" class="jlObjectType jlMethod" text="Method" /></summary>



```julia
dchxy(TAU1::Float64, CFA::Vector{Float64}, NCASE::Int) 
    -> (CHX::Vector{Float64}, CHY::Vector{Float64}, nomitr::Int)
```


Compute Chandrasekhar&#39;s X and Y functions for radiative transfer.

**Description**

This routine evaluates the X- and Y-functions of Chandrasekhar using double precision arithmetic. The method starts with the fourth approximation given in Sec. 59 of Chandrasekhar’s _Radiative Transfer_ (Dover Publications, 1960), and iteratively refines the values according to the procedure in Sec. 60. Iteration terminates when successive corrected values of the Y-function agree to four significant figures.

**Inputs**
- `TAU1::Float64`:   Normal optical thickness of the atmosphere.   Must be ≤ 2.0.
  
- `CFA::NTuple{3,Float64}`:   Coefficients of the characteristic function in polynomial form:   ```math C(μ) = Σⱼ Aⱼ * μ^(2(j-1)),   j = 1,2,3
  

Outputs

CHX::Vector{Float64} Values of the X-function at 101 evenly spaced μ values from 0.00 to 1.00 in steps of 0.01.

CHY::Vector{Float64} Values of the Y-function at the same μ grid.

nomitr::Int Number of iterations performed before convergence.

Notes

If ncase != 0, a conservative case is assumed and a standard solution is returned. The program terminates with an error if:
- tau1 &gt; 2.0
  
- the characteristic function is negative for any μ
  
- the integral of the characteristic function exceeds 0.5
  

References

https://en.wikipedia.org/wiki/Chandrasekhar%27s_X-_and_Y-function

McCullough, E. C., &amp; Porter, W. P. (1971). Computing clear day solar radiation  spectra for the terrestrial ecological environment. Ecology, 52(6), 1008–1015.      https://doi.org/10.2307/1933806


<Badge type="info" class="source-link" text="source"><a href="https://github.com/BiophysicalEcology/Microclimate.jl/blob/249615d416695025a74967af1bdbeecbc4c201a6/src/radiation.jl#L591-L643" target="_blank" rel="noreferrer">source</a></Badge>

</details>

<details class='jldocstring custom-block' open>
<summary><a id='Microclimate.elevation_correction-Tuple{Any}' href='#Microclimate.elevation_correction-Tuple{Any}'><span class="jlbinding">Microclimate.elevation_correction</span></a> <Badge type="info" class="jlObjectType jlMethod" text="Method" /></summary>



```julia
elevation_correction(elevation)
```


Calculates smooth polynomial approximations of atmospheric constituent correction factors  as a function of elevation (based on Kearney&#39;s modification of the ALTFCT array originally  from SOLAR.DAT). Input `elevation` is the elevation in meters and can include units.

**Description**

The array `ELEVFCT(i, j)` represents the **ratio of the total amount of a given  atmospheric constituent (index j) above the elevation of interest (index i) to that  above sea level**. The constituent indices are:
- j = 1: Molecular
  
- j = 2: Aerosol
  
- j = 3: Ozone
  
- j = 4: Water vapor
  

For j = 1–3, values are derived from standard profiles. For water vapor (j = 4), no  standard profile exists, so only `ELEVFCT(1, 4)` is defined as 1.00.

The elevation index i runs from 1 to 21, corresponding to elevations from sea level to  20 km in 1 km steps.

This function implements fitted polynomials to reproduce this correction smoothly  from `elevation` (in meters) using continuous approximation.

**Returns**

A `NamedTuple` with the fields:
- `molecular_corr`
  
- `aerosol_corr`
  
- `ozone_corr`
  
- `water_vapor_corr`
  


<Badge type="info" class="source-link" text="source"><a href="https://github.com/BiophysicalEcology/Microclimate.jl/blob/249615d416695025a74967af1bdbeecbc4c201a6/src/radiation.jl#L97-L132" target="_blank" rel="noreferrer">source</a></Badge>

</details>

<details class='jldocstring custom-block' open>
<summary><a id='Microclimate.hour_angle' href='#Microclimate.hour_angle'><span class="jlbinding">Microclimate.hour_angle</span></a> <Badge type="info" class="jlObjectType jlFunction" text="Function" /></summary>



```julia
hour_angle(t::Quantity, longitude_correction::Quantity) -> Quantity
```


Compute the solar hour angle `h` in radians.

**Arguments**
- `t`: Local solar hour (e.g., `14.0`)
  
- `longitude_correction`: Longitude correction in hours (e.g., `0.5`)
  

**Returns**
- Hour angle `h` as a `Quantity` in radians
  
- Time at solar noon, `tsn` as a time in hours
  

**Reference**

McCullough &amp; Porter 1971, Eq. 6


<Badge type="info" class="source-link" text="source"><a href="https://github.com/BiophysicalEcology/Microclimate.jl/blob/249615d416695025a74967af1bdbeecbc4c201a6/src/radiation.jl#L22-L38" target="_blank" rel="noreferrer">source</a></Badge>

</details>

<details class='jldocstring custom-block' open>
<summary><a id='Microclimate.soil_properties!-Tuple{NamedTuple, Any}' href='#Microclimate.soil_properties!-Tuple{NamedTuple, Any}'><span class="jlbinding">Microclimate.soil_properties!</span></a> <Badge type="info" class="jlObjectType jlMethod" text="Method" /></summary>



```julia
soil_props_vector!(buffers, soil_thermal; terrain, soil_temperature, soil_moisture)
```


Compute soil properties for vectors of soil temperature and moisture using broadcasting.

**TODO these should have readable names**

Returns three arrays: `λ_b`, `cp_b`, `ρ_b`.


<Badge type="info" class="source-link" text="source"><a href="https://github.com/BiophysicalEcology/Microclimate.jl/blob/249615d416695025a74967af1bdbeecbc4c201a6/src/soil_properties.jl#L141-L148" target="_blank" rel="noreferrer">source</a></Badge>

</details>

<details class='jldocstring custom-block' open>
<summary><a id='Microclimate.soil_properties-Tuple{CampbelldeVriesSoilThermal}' href='#Microclimate.soil_properties-Tuple{CampbelldeVriesSoilThermal}'><span class="jlbinding">Microclimate.soil_properties</span></a> <Badge type="info" class="jlObjectType jlMethod" text="Method" /></summary>



```julia
soil_properties(soil_thermal; soil_temperature, soil_moisture, terrain)
```


Compute bulk soil properties — thermal conductivity (`λ_b`), volumetric heat capacity (`cp_b`),  and bulk density (`ρ_b`) — for a given soil layer.

**Arguments**
- `soil_thermal::AbstractSoilThermalModel`
  

**Keywords**
- `terrain`
  
- `soil_temperature::Quantity`: Soil temperature in Kelvin.
  
- `soil_moisture::Real`: Volumetric soil moisture (m³/m³).
  

**Returns**

A named tuple `(λ_b, cp_b, ρ_b)`:
- `λ_b::Quantity`: Bulk thermal conductivity (W/m/K)
  
- `cp_b::Quantity`: Bulk volumetric heat capacity (J/kg/K)
  
- `ρ_b::Quantity`: Bulk density (kg/m³)
  

**Theory**

This function calculates soil thermal properties using the Campbell &amp; Norman (1991, 1994)  approach, which accounts for:
1. **Soil composition**: Soil is modeled as a mixture of mineral, water, and air fractions.  Each fraction contributes to bulk properties depending on its volumetric fraction.
  
2. **Water content effects**: The function includes a water recirculation factor (`f_water`)  to model how moisture affects heat transfer.
  
3. **Phase-dependent conductivity**: Effective thermal conductivity of soil (`λ_b`) is computed  using a generalization of de Vries’ mixing model, considering interactions between  mineral, liquid, and gas components.
  
4. **Temperature dependence**: Thermal conductivity of water and air are adjusted with temperature.
  
5. **Vapor transport**: Small contribution from vapor diffusion is included via a finite-difference  approximation of saturated vapor pressure (`∇x`).
  

This method provides an accurate representation of heat transfer in variably wet soils  for land surface or microclimate modeling.

**References**

Campbell, G. S., Jungbauer, J. D. Jr., Bidlake, W. R., &amp; Hungerford, R. D. (1994). Predicting   the effect of temperature on soil thermal conductivity. Soil Science, 158(5), 307–313.

Campbell, G. S., &amp; Norman, J. M. (1998). Environmental Biophysics. Springer.


<Badge type="info" class="source-link" text="source"><a href="https://github.com/BiophysicalEcology/Microclimate.jl/blob/249615d416695025a74967af1bdbeecbc4c201a6/src/soil_properties.jl#L1-L54" target="_blank" rel="noreferrer">source</a></Badge>

</details>

<details class='jldocstring custom-block' open>
<summary><a id='Microclimate.solrad-Tuple{SolarRadiation}' href='#Microclimate.solrad-Tuple{SolarRadiation}'><span class="jlbinding">Microclimate.solrad</span></a> <Badge type="info" class="jlObjectType jlMethod" text="Method" /></summary>



```julia
solrad(solar_radiaion_model; kw...)
```


Compute clear sky solar radiation at a given place and time using a detailed atmospheric radiative transfer model.

**Arguments**
- `solar_radiaion_model`:
  

**Keyword Arguments**
- `days::Vector{Float64}`: Days of the year (1–365/366) to evaluate.
  
- `hours::Vector{Float64}`: Decimal hours of the day (0.0–23.0).
  
- `latitude::Quantity`: Latitude in degrees, e.g. `43.0u"°"`.
  
- `longitude_correction::Real=0.0`: Longitude correction in hours (positive west of standard meridian).
  
- `year::Real`: Year used for ozone table lookup.
  
- `terrain`
  
- `albedo::Vector{<:Real}=fill(0.15, length(days))`: Daily ground albedo, fraction [0, 1].
  

**Returns**

A named tuple containing:
- `λ::Vector`: Wavelengths (typically in µm).
  
- `λDirect::Vector`: Spectral direct irradiance [W/m²/µm].
  
- `λRayleigh::Vector`: Spectral Rayleigh-scattered irradiance [W/m²/µm].
  
- `λScattered::Vector`: Spectral diffuse (scattered) irradiance [W/m²/µm].
  
- `λGlobal::Vector`: Spectral global irradiance (direct + diffuse) [W/m²/µm].
  
- `Direct::Float64`: Broadband direct irradiance [W/m²].
  
- `Rayleigh::Float64`: Broadband Rayleigh-scattered irradiance [W/m²].
  
- `Scattered::Float64`: Broadband scattered (diffuse) irradiance [W/m²].
  
- `Global::Float64`: Broadband global irradiance (direct + diffuse) [W/m²].
  
- `Zenith::Float64`: Solar zenith angle [degrees].
  
- `ZenithSlope::Float64`: Slope solar zenith angle [degrees].
  
- `Azimuth::Float64`: Solar azimuth angle [degrees].
  
- `doy::Int`: Day of year.
  
- `hour::Float64`: Decimal hour of day.
  

**Notes**
- Radiation units are returned in `W/m²`. Internally, units like `mW/cm²` are used and converted as necessary using `Unitful.jl`.
  
- Topographic shading is included via the `horizon_angles` input (horizon angle mask) but cloud effects on scattered solar should be added later.
  
- Outputs are computed for each (day, hour) combination in the input vectors.
  
- In optical air mass &#39;arims&#39; calculation the difference between apparent and true zenith angle is neglected for z less than 88 degrees
  
- Variation of airms with altitude is ignored since it is negligible up to at least 6 km above sea level
  

**References**

FD and FDQ derived from tables in Dave and Furukawa (1967) Dave, J. V., &amp; Furukawa, P. M. (1966). Scattered radiation in the ozone   absorption bands at selected levels of a terrestrial, Rayleigh atmosphere (Vol. 7).  Americal Meteorological Society.


<Badge type="info" class="source-link" text="source"><a href="https://github.com/BiophysicalEcology/Microclimate.jl/blob/249615d416695025a74967af1bdbeecbc4c201a6/src/radiation.jl#L1177-L1229" target="_blank" rel="noreferrer">source</a></Badge>

</details>

<details class='jldocstring custom-block' open>
<summary><a id='Microclimate.sublayer_stanton-Tuple{Any, Any}' href='#Microclimate.sublayer_stanton-Tuple{Any, Any}'><span class="jlbinding">Microclimate.sublayer_stanton</span></a> <Badge type="info" class="jlObjectType jlMethod" text="Method" /></summary>



```julia
sublayer_stanton(z0, u_star)
```


Compute the Stanton number for the viscous sublayer.


<Badge type="info" class="source-link" text="source"><a href="https://github.com/BiophysicalEcology/Microclimate.jl/blob/249615d416695025a74967af1bdbeecbc4c201a6/src/boundary_layer.jl#L314-L318" target="_blank" rel="noreferrer">source</a></Badge>

</details>

